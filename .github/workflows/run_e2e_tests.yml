name: Run Postman Tests with Newman

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to test (dev, stage, prod)'
        required: false
        default: 'dev'
  workflow_call:
    inputs:
      namespace:
        required: false
        default: 'dev'
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      RESOURCE_GROUP:
        required: true

jobs:
  postman-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci-templates repo
        uses: actions/checkout@v3
        with:
          repository: ecommerce-microservices-lab/ci-templates
          ref: main

      - name: Set Azure credentials
        uses: azure/login@v1
        with:
          creds: >-
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Clear Azure CLI MSAL cache
        run: rm -f ~/.azure/msal_http_cache.bin

      - name: Upgrade Azure CLI to latest
        run: |
          az upgrade --yes
          az version

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Get AKS credentials
        run: |
          which az
          az version
          az aks get-credentials \
            --resource-group "${{ secrets.RESOURCE_GROUP }}" \
            --name microservices-cluster-prod \
            --overwrite-existing

      - name: Get API Gateway IP
        id: get_ip
        run: |
          NAMESPACE="${{ inputs.namespace }}"
          
          # Wait for IP to be assigned
          for i in {1..30}; do
            IP=$(kubectl get svc api-gateway -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [[ -n "$IP" && "$IP" != "null" ]]; then
              echo "API_GATEWAY_IP=$IP" >> $GITHUB_OUTPUT
              echo "‚úÖ Got API Gateway IP: $IP for namespace $NAMESPACE"
              exit 0
            fi
            echo "‚è≥ Waiting for IP... (attempt $i/30)"
            sleep 5
          done
          
          echo "‚ùå Failed to get API Gateway IP"
          exit 1

      - name: Verify Services in Eureka
        run: |
          NAMESPACE="${{ inputs.namespace }}"
          
          echo "üîç Verifying all services are registered in Eureka..."
          
          # Port-forward Eureka temporarily
          kubectl port-forward -n "$NAMESPACE" svc/service-discovery 8761:8761 > /dev/null 2>&1 &
          EUREKA_PF_PID=$!
          sleep 5
          
          # Expected services
          EXPECTED_SERVICES=("API-GATEWAY" "USER-SERVICE" "PRODUCT-SERVICE" "PAYMENT-SERVICE" "ORDER-SERVICE" "SHIPPING-SERVICE" "FAVOURITE-SERVICE" "PROXY-CLIENT")
          
          for i in {1..30}; do
            REGISTERED=$(curl -s http://localhost:8761/eureka/apps | grep -o '<name>[^<]*</name>' | grep -v 'MyOwn' || echo "")
            
            ALL_REGISTERED=true
            MISSING=()
            
            for svc in "${EXPECTED_SERVICES[@]}"; do
              if echo "$REGISTERED" | grep -q "$svc"; then
                echo "  ‚úÖ $svc"
              else
                echo "  ‚ùå $svc - missing"
                MISSING+=("$svc")
                ALL_REGISTERED=false
              fi
            done
            
            if [ "$ALL_REGISTERED" = true ]; then
              echo "‚úÖ All services registered in Eureka"
              kill $EUREKA_PF_PID 2>/dev/null
              exit 0
            fi
            
            echo "‚è≥ Waiting for services... (attempt $i/30)"
            sleep 5
          done
          
          echo "‚ùå Failed to register all services in Eureka"
          echo "   Missing: ${MISSING[@]}"
          kill $EUREKA_PF_PID 2>/dev/null
          exit 1

      - name: Update Postman collection with dynamic IP
        run: |
          API_IP="${{ steps.get_ip.outputs.API_GATEWAY_IP }}"
          API_URL="http://$API_IP:8080/app/api"
          
          echo "üìù Updating Postman collection with URL: $API_URL"
          
          # Debug: list files
          pwd
          ls -la
          echo "Looking for postman collection..."
          find . -name "*postman*" -type f
          
          # Update the url variable in the collection
          sed -i "s|\"value\": \"http://.*/app/api\"|\"value\": \"$API_URL\"|" api_gateway.postman_collection.json
          
          echo "‚úÖ Updated Postman collection"

      - name: Update K6 test with dynamic IP
        run: |
          API_IP="${{ steps.get_ip.outputs.API_GATEWAY_IP }}"
          API_URL="http://$API_IP:8080/actuator/health"
          
          echo "üìù Updating K6 test with URL: $API_URL"
          
          # Update the URL in the K6 test
          sed -i "s|http://.*:8080/actuator/health|$API_URL|" tests/performance/load-test.js
          
          echo "‚úÖ Updated K6 test"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install k6
        run: |
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt update
          sudo apt install -y k6

      - name: Run performance test
        run: k6 run tests/performance/load-test.js

      - name: Run ZAP Baseline Scan
        id: zap_scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: 'http://${{ steps.get_ip.outputs.API_GATEWAY_IP }}:8080'
          fail_action: false
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        env:
          ZAP_ALERT_LEVEL: 'LOW'

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
          retention-days: 30

      - name: Check ZAP high severity alerts (Report Only)
        if: always() && steps.zap_scan.conclusion != 'cancelled'
        continue-on-error: true
        run: |
          echo "üîç Checking ZAP report for high severity alerts..."
          echo "‚ö†Ô∏è  NOTE: This step will NOT fail the pipeline, but will report findings"
          echo ""
          
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Check if report exists
          if [ ! -f report_json.json ]; then
            echo "‚ö†Ô∏è  ZAP report not found, skipping severity check"
            exit 0
          fi
          
          # Check for high severity alerts (riskcode: 3=HIGH, 4=CRITICAL)
          # ZAP JSON format: {"@version": "...", "site": [{"@name": "...", "alerts": [{"pluginid": "...", "alert": "...", "riskcode": "3", "riskdesc": "..."}]}]}
          HIGH_ALERTS=$(jq -r '.site[]?.alerts[]? | select((.riskcode == "3") or (.riskcode == "4")) | "ID: \(.pluginid // "unknown") - \(.alert // "Unknown") - \(.riskdesc // "No description")"' report_json.json 2>/dev/null || echo "")
          
          # Count alerts by severity
          CRITICAL_COUNT=$(jq -r '.site[]?.alerts[]? | select(.riskcode == "4") | .pluginid' report_json.json 2>/dev/null | wc -l | tr -d ' ')
          HIGH_COUNT=$(jq -r '.site[]?.alerts[]? | select(.riskcode == "3") | .pluginid' report_json.json 2>/dev/null | wc -l | tr -d ' ')
          MEDIUM_COUNT=$(jq -r '.site[]?.alerts[]? | select(.riskcode == "2") | .pluginid' report_json.json 2>/dev/null | wc -l | tr -d ' ')
          LOW_COUNT=$(jq -r '.site[]?.alerts[]? | select(.riskcode == "1") | .pluginid' report_json.json 2>/dev/null | wc -l | tr -d ' ')
          
          echo "üìä ZAP Scan Summary:"
          echo "   CRITICAL: $CRITICAL_COUNT"
          echo "   HIGH:     $HIGH_COUNT"
          echo "   MEDIUM:   $MEDIUM_COUNT"
          echo "   LOW:      $LOW_COUNT"
          echo ""
          
          if [ -n "$HIGH_ALERTS" ]; then
            echo "‚ö†Ô∏è  ZAP detected HIGH/CRITICAL severity alerts:"
            echo "$HIGH_ALERTS"
            echo ""
            echo "üìã Review these findings in the ZAP report artifacts"
            echo "   To allow specific alerts, document them in docs/pruebas/zap-exceptions.md"
            echo "   Then update the validation script to exclude them by plugin ID"
            echo ""
            echo "‚ö†Ô∏è  Pipeline continues, but please review these findings"
            # Don't exit 1, just report
          else
            echo "‚úÖ No high severity alerts found"
          fi
          
          # Always exit 0 to not fail the pipeline
          exit 0

      - name: Install Newman
        run: npm install -g newman

      - name: Run Newman collection with dynamic URL
        run: |
          newman run api_gateway.postman_collection.json

